<h1>収支一覧</h1>

<h2>検索</h2>
<div id="search_field">
  <%= form_with url: items_path, method: :get, local: true do |f| %>

    <h3>年月</h3>
    <% year_months.each_with_index do |year_month, i| %>
      <label>
        <%= f.check_box :"search[year_months][]",
          { checked: year_month.in?(params[:search][:year_months] || []) },
          year_month, nil %>
        <%= year_month %>
      </label>
      <% if (i+1) % 6 == 0 %>
        <br>
      <% end %>
    <% end %>

    <h3>ユーザー</h3>
    <% @users.each_with_index do |user| %>
      <label>
        <%=
          f.check_box :"search[user_ids][]",
            { checked: user.id.to_s.in?(params[:search][:user_ids] || []) },
            user.id, nil %>
        <%= user.name %>
      </label>
    <% end %>

    <h3>収支分類</h3>
    <% @payment_methods.each_with_index do |payment_method| %>
      <label>
        <%=
          f.check_box :"search[payment_method_ids][]",
            { checked: payment_method.id.to_s.in?(params[:search][:payment_method_ids] || []) },
            payment_method.id, nil %>
        <%= payment_method.name %>
      </label>
    <% end %>

    <h3>収支方法</h3>
    <% @payment_classifications.each_with_index do |payment_classification| %>
      <label>
        <%=
          f.check_box :"search[payment_classification_ids][]",
            { checked: payment_classification.id.to_s.in?(params[:search][:payment_classification_ids] || []) },
            payment_classification.id, nil %>
        <%= payment_classification.name %>
      </label>
    <% end %>

    <div>
      <%= f.submit "検索" %>
    </div>
  <% end %>
</div>

<h2>グラフ</h2>

<%= line_chart @items_line_chart %>

<h2>収支月別</h2>
<table>
  <thead>
    <tr>
      <th>年月</th>
      <th>収入</th>
      <th>支払</th>
      <th>収支</th>
    </tr>
  </thead>
  <tbody>
    <% @balances_by_month.each do |balance_by_month| %>
      <tr>
        <td><%= balance_by_month[:year_month] %></td>
        <% if balance_by_month[:income] < 0 %>
          <td align="right" class="red"><%= balance_by_month[:income].to_s(:delimited) %></td>
        <% else %>
          <td align="right" class="blue"><%= balance_by_month[:income].to_s(:delimited) %></td>
        <% end %>
        <% if balance_by_month[:payment] < 0 %>
          <td align="right" class="red"><%= balance_by_month[:payment].to_s(:delimited) %></td>
        <% else %>
          <td align="right" class="blue"><%= balance_by_month[:payment].to_s(:delimited) %></td>
        <% end %>
        <% if balance_by_month[:balance] < 0 %>
          <td align="right" class="red"><%= balance_by_month[:balance].to_s(:delimited) %></td>
        <% else %>
          <td align="right" class="blue"><%= balance_by_month[:balance].to_s(:delimited) %></td>
        <% end %>
      </tr>
    <% end %>
  </tbody>
</table>

<h2>収支分類別</h2>
<table>
  <thead>
    <tr>
      <th>支払分類</th>
      <th>金額</th>
    </tr>
  </thead>
  <tbody>
    <% @balances_by_classification.each do |classfication_id, amount| %>
      <tr>
        <td><%= PaymentClassification.find(classfication_id).name %></td>
        <% if amount < 0 %>
          <td align="right" class="red"><%= amount.to_s(:delimited) %></td>
        <% else %>
          <td align="right" class="blue"><%= amount.to_s(:delimited) %></td>
        <% end %>
      </tr>
    <% end %>
  </tbody>
</table>


<h2>収支詳細</h2>
<table>
  <thead>
    <tr>
      <th>支払日</th>
      <th>支払金額</th>
      <th>ユーザー</th>
      <th>支払分類</th>
      <th>支払方法</th>
      <th>備考</th>
      <th colspan="2"></th>
    </tr>
  </thead>

  <tbody>
    <% @items.each do |item| %>
      <tr>
        <td><%= item.payed_on %></td>
        <% if item.type == "Payment" %>
          <td align="right" class="red"><%= item.amount.to_s(:delimited) %></td>
        <% elsif item.type == "Income" %>
          <td align="right" class="blue"><%= item.amount.to_s(:delimited) %></td>
        <% end %>
        <td><%= item.user.name %></td>
        <td><%= item.payment_classification.name %></td>
        <td><%= item.payment_method.name %></td>
        <td><%= item.note %></td>
        <td>
          <% if item.type == "Payment" %>
            <%= link_to '編集', edit_payment_path(item) %>
          <% elsif item.type == "Income" %>
            <%= link_to '編集', edit_income_path(item) %>
          <% end %>
        </td>
        <td><%= link_to '削除', item, method: :delete, data: { confirm: '削除してよろしいですか？' } %></td>
      </tr>
    <% end %>
  </tbody>
</table>
